<project name="unit">

	<property name="test.build.dir" location="${basedir}/../../build/test" />
	<property file="${test.build.dir}/test.properties" />

	<path id="lib.path.id" >
		<fileset dir="${lib.dir}" />
		<fileset dir="${test.lib.dir}" />
		<fileset dir="${project.lib.dir}" excludes="${ant.project.name}-*.jar" />
	</path>

	<path id="test.path.id">

		<fileset dir="${lib.dir}" />
		<fileset dir="${test.lib.dir}" />
		<fileset dir="${project.lib.dir}"/>

		<pathelement location="${test.classes.dir}" />
		<pathelement location="${instrumented.dir}" />
	</path>

	<target name="load-cobertura">
		<path id="cobertura.lib.path">
			<fileset dir="${test.lib.dir}" includes="*.jar" />
		</path>
		<taskdef resource="tasks.properties" classpathref="cobertura.lib.path" />
	</target>

	<!-- test -->
	<target name="unittest" depends="instrument">
		<echo message="${ant.project.name}.jar"></echo>
		<mkdir dir="${junit.report.dir}"/>
		<junit haltonfailure="false" fork="yes" forkmode="once">
			<test name="com.pilgrim_lifestyle.model.eventer.AllTest" todir="${junit.report.dir}" />
			<formatter type="xml" />

			<classpath location="${test.lib.dir}/cobertura.jar"/>
			<classpath location="${instrumented.dir}"  />
			<classpath>
				<fileset dir="${lib.dir}" includes="*.jar"/>
				<fileset dir="${test.lib.dir}" includes="*.jar"/>
				<fileset dir="${project.lib.dir}" includes="*.jar" excludes="${ant.project.name}-*.jar"/>
				<pathelement location="${test.classes.dir}" />
				<pathelement location="${classes.dir}" />
			</classpath>
		</junit>
	</target>

	<!-- cobertura -->
	<target name="instrument" depends="load-cobertura">
		<cobertura-instrument todir="${instrumented.dir}">
			<fileset dir="${classes.dir}">
				<include name="**/*.class" />
				<exclude name="**/*Test*.class" />
			</fileset>
			<classpath refid="lib.path.id" />
		</cobertura-instrument>
	</target>

	<target name="coverage-report" depends="unittest">
		<cobertura-report srcdir="${projects.dir}/src/main/java" destdir="${cobertura.report.dir}" format="xml" />
	</target>

</project>